# (PART) GIS Basic {.unnumbered}

# Coordinate Systems

In this chapter, we will work with the following packages.
Before starting any exercises, make sure to run the following code.

```{r}

library(tidyverse)
library(sf)
library(mapview)

```

## Getting Started

What are Coordinate Reference Systems (CRS)?
CRS define how spatial data are projected onto the Earth's surface—essentially, how locations on the curved Earth are represented on a flat map.

To get a sense of how CRS works in practice, let's explore a dataset on fish distributions from North Carolina.
This regional dataset contains georeferenced sampling sites using [longitude and latitude](https://www.latlong.net/) coordinates.

We'll start by reading the dataset from the data sub-directory in your R project:

```{r}
df_fish <- read_csv("data/data_finsync_nc.csv")
```

This dataset contains the following columns:

```{r cl-table, echo = FALSE}

df_cl_table <- tibble(Column = colnames(df_fish),
                      Description = c("Site name",
                                      "Sampling year",
                                      "Sampling date",
                                      "Longitude",
                                      "Latitude",
                                      "Scientific name",
                                      "Presence/absence of a species (1, present; 0, absent")
                      )

knitr::kable(df_cl_table)
```

Let's take a quick view of the dataframe:

```{r}
print(df_fish)
```

Since this dataframe contains longitude and latitude columns, we can make this data as **georeferenced**.
To do so, we'll need to use functions from `sf` package, which makes the mere numbers of coordinates linked to CRS of your choice.
Specifically, we first convert the original dataframe to unique combinations of logitude & latitude (= unique location) with `dplr::distinct()` then use `sf::st_as_sf()`:

```{r}
sf_site <- df_fish %>% 
  distinct(site_id, lon, lat) %>% # get unique combinations of longitude & latitude
  st_as_sf(coords = c("lon", "lat"),
           crs = 4326)

print(sf_site)
```

It looks similar to what we had as a `tibble`, but this version includes additional lines of metadata that describe key *geospatial information*.
This data frame now represents a **point** layer (see the `Geometry type`), and includes a *bounding box* that defines the longitudinal and latitudinal extent (`Bounding box`).
It also specifies the CRS in use (`Geodetic CRS`).
The object class now includes `sf`.

```{r}
class(sf_site)
```

Once the data frame is converted to the `sf` class, you can apply a variety of spatial mapping functions available in R.
For example, we can quickly visualize the data using the `mapview::mapview()` function:

```{r}
mapview(sf_site,
        legend = FALSE)
```

Fantastic — it works!
This marks an important first step toward harnessing the full potential of RGIS.

You may save this object using `saveRDS()` function in R – in doing so, you can load this object for later use (see Chapter \@ref(vector-data-sf-basics)):

```{r, eval = FALSE}
saveRDS(sf_site,
        file = "data/sf_nc_county.rds")
```

But, heads-up!
If you don’t fully understand the CRS in use, there's a high risk of performing misinformed analyses — **potentially serious enough to invalidate your conclusions.** Therefore, it's important to take the time to understand several key aspects of CRS before conducting any spatial analysis.
One of those is the difference between **Geodetic vs. Projected CRS**. The CRS we used in the fish data example is WGS 84, which is a type of geodetic CRS.

## Geodetic vs. Projected

CRS are essential for accurately representing spatial data on the Earth's surface.
A *geodetic CRS* models the Earth as a 3D ellipsoid and represents locations using angular coordinates — latitude and longitude.
These systems are ideal for global positioning and mapping where preserving true geographic coordinates is important.
However, because they represent curved surfaces on a spherical model, they are not suitable for accurate distance or area calculations on flat maps.
Common examples of geodetic CRS include WGS 84 (`EPSG:4326`), which is used by GPS and most global datasets, and NAD83 (`EPSG:4269`), which is widely used in North America.

In contrast, a *projected CRS* transforms geographic coordinates onto a 2D surface using mathematical projections.
This allows for accurate measurements of distance, area, or direction in localized regions.
Projected systems distort some properties (e.g., shape, area, or scale) but can be tailored for specific mapping needs.
Examples of projected CRS include UTM zones (e.g., UTM Zone 17N, `EPSG:32617`) and State Plane systems like North Carolina State Plane (`EPSG:32119`), which are optimized for regional accuracy and are commonly used in government or environmental datasets.

Visit [this website](https://www.earthdatascience.org/courses/use-data-open-source-python/intro-vector-data-python/spatial-data-vector-shapefiles/geographic-vs-projected-coordinate-reference-systems-python/?utm_source=chatgpt.com) for visual aids.

+---------------+----------------------------------------------------------------------------------------+------------------------------------------------+-------------------------------------------------------+
| CRS Type      | Representation                                                                         | Advantages                                     | Disadvantages                                         |
+===============+========================================================================================+================================================+=======================================================+
| **Geodetic**  | **Latitude and longitude** on an ellipsoidal model of Earth                            | Global coverage (e.g., GPS)                    | **NOT** for distance, area, or direction calculations |
|               |                                                                                        |                                                |                                                       |
|               |                                                                                        | Standard for data exchange and web maps        | Curved surface not ideal for flat map operations      |
|               |                                                                                        |                                                |                                                       |
|               |                                                                                        | Easy to interpret (lat/lon)                    |                                                       |
+---------------+----------------------------------------------------------------------------------------+------------------------------------------------+-------------------------------------------------------+
| **Projected** | **X/Y Cartesian coordinates** on a flat surface derived from a projection of the Earth | Enables accurate measurements (distance, area) | Distorts some geographic properties                   |
|               |                                                                                        |                                                |                                                       |
|               |                                                                                        | Optimized for regional analysis                | Limited to specific regions                           |
|               |                                                                                        |                                                |                                                       |
|               |                                                                                        | Supports specialized map projections           | Must choose the right projection for your purpose     |
+---------------+----------------------------------------------------------------------------------------+------------------------------------------------+-------------------------------------------------------+

: Comparison of geodetic and projected CRS.

## CRS transformation

What if we want to perform spatial analysis on data provided in a geodetic CRS, like in the fish data example?
Can we still calculate distances or areas?
At first glance, it might seem impossible — but no worries.
Thanks to extensive work in geospatial science, we now have well-established methods for transforming between CRS.

For example, suppose we want to calculate the distance between two sampling sites — say, the first two rows in our data frame.

```{r}
sf_ft_wgs <- sf_site %>% 
  slice(c(1, 2))

print(sf_ft_wgs)
```

Let's walk through how to do this using a projected CRS.
If we want to calculate the distance between these two sites, we can use the `sf::st_distance()` function — **but only after transforming the coordinates to a projected CRS**[^01-crs-1].
Here, we'll use UTM Zone 17N, which is well-suited for projecting spatial data in North Carolina.
To do this, we’ll apply `sf::st_transform()` to convert our geodetic CRS (e.g., WGS 84) into the projected CRS for UTM Zone 17N based on WGS 84 (EPSG:32617).

[^01-crs-1]: This used to require a CRS transformation, but nowadays, the `sf` package can automatically approximate distances in meters even when geometries are in a geodetic CRS like WGS84.
    This approximation uses great-circle (spherical) or ellipsoidal calculations and can be sufficiently accurate for large-scale analyses — particularly when maintaining a consistent CRS across broad regions is more important than local precision.
    However, for local or high-precision analyses (e.g., measuring distances within a city or watershed), it's still recommended to transform to a projected CRS to ensure accuracy.

```{r}
sf_ft_utm <- sf_ft_wgs %>% 
  st_transform(crs = 32617)

print(sf_ft_utm)
```

Now, the CRS metadata shows: `Projected CRS: WGS 84 / UTM zone 17N`.
You’ll also notice that the bounding box values have changed to large numbers (check with `st_bbox(sf_ft_utm)`), which clearly are not in longitude or latitude.

That’s because the coordinates are now expressed in meters, representing positions along the X and Y axes of a 2D projected map.
With this transformation complete, we’re ready to perform geospatial analysis.

Let’s start by calculating the distance between two sampling sites:

```{r}
st_distance(sf_ft_utm)
```

These two sites are $\sim$ `r units::set_units(st_distance(sf_ft_utm)[1,2], "km") %>% round()` km away, shown in a matrix format.

## Take Home

In a nutshell, **geodetic CRS** define how locations are mapped onto a 3D model of the Earth (typically an ellipsoid), preserving their original latitude and longitude values.
**Projected CRS**, on the other hand, define how those geographic locations are transformed (or "projected") onto a flat, 2D surface.
However, because no projection can preserve all spatial properties at once, **you must choose a projected CRS based on the geometric attributes most important to your analysis** — such as area, distance, or direction.
Additionally, projected CRS are typically designed for **use within specific geographic regions**, and using one outside its intended area can introduce significant distortion.
