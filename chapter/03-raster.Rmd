# Raster Data (`terra` basics)

In this chapter, we will work with the following packages.
Before starting any exercises, make sure to run the following code.

```{r}
if (!require(pacman)) install.packages("packman")

pacman::p_load(tidyverse,
               terra,
               tidyterra)
```

## Raster Data in GIS

**Raster data** in GIS represents geographic information as a grid of pixels (or cells), where each cell has a value corresponding to a specific attribute such as elevation, temperature, or land cover type.
Unlike vector data (points, lines, and polygons), raster data is particularly well-suited for continuous phenomena that vary smoothly across space.
The resolution of a raster is determined by the size of its cells, with smaller cells providing finer detail.
Raster datasets are often used in environmental modeling, remote sensing, and climate analysis, as they can efficiently represent large-scale spatial patterns.

The `terra` package in R is a modern tool for handling raster (and vector spatial data), designed to replace the older `raster` package with faster performance and more intuitive syntax.
It allows users to read, write, manipulate, and analyze raster datasets of various formats (e.g., GeoTIFF, NetCDF) and supports integration with vector data through the `sf` and `sp` packages.

### Data Format

A **GeoTIFF** is a commonly used raster file format in GIS that stores image data along with georeferencing information.
That is, data that tells the software where the image belongs on the Earth's surface.
Unlike a regular TIFF image, a GeoTIFF includes embedded metadata such as CRS, map projection, pixel size, and spatial extent.

### Read/Export Raster Data

In the context of using the `terra` package in R, GeoTIFFs (`.tif`) are a standard input and output format for raster analysis.
For example, you can load a GeoTIFF containing data using `terra::rast()`, after which you may perform spatial operations such as cropping or masking.

```{r}
(spr_ex <- rast("data/spr_example.tif"))
```

The output summarizes the contents of a `SpatRaster` object.
It has 90 rows and 95 columns, forming a grid of raster cells (line `dimensions:`), with one data layer (or band).
Each cell represents a rectangular area of 0.008333333 degrees in both x (longitude) and y (latitude) directions (line `resolution:`).
The spatial extent of the raster is defined by the minimum and maximum coordinates in both directions (line `extent:`), covering a small area in Western Europe in this specific data.
The CRS is WGS 84 (line `coord. ref.`), which uses geographic coordinates (longitude and latitude).
The raster contains elevation data (line `name:`), with values ranging from 141 to 547 (lines `min value:` and `max value:`) in meters.

The raster object in R can be exported using `terra::writeRaster()`:

```{r, eval = FALSE}
# overwrite = TRUE enables overwriting
writeRaster(x = spr_ex, 
            filename = "data/spr_elev.tif",
            overwrite = TRUE)
```

The object is now saved as `spr_elev.tif` in the `data` subdirectory, specified in the `filename` argument.
Easy enough!

### Mapping

Unlike `sf` vector objects, raster data is not natively supported by `ggplot2` for direct visualization.
This means that typical `ggplot2` functions like `geom_sf()` won't work out of the box for raster layers.

Fortunately, the `tidyterra` package extends `ggplot2` by providing functions designed specifically for raster visualization.
Here, we can use `tidyterra::geom_spatraster()` to display raster data in a `ggplot2`-friendly format.
In the following example, we’ll use `geom_spatraster()` to visualize the raster file `spr_ex` we previously loaded into R.

```{r}
ggplot() +
  geom_spatraster(data = spr_ex)
```

## Crop

The `crop()` function is a useful tool for trimming a raster layer down to a defined extent.
This is particularly helpful when working with large raster files, which can be slow to process and visualize.

### Crop by a given extent {.unnumbered}

To see how cropping works, let’s start by loading a precipitation dataset.
This raster is a product from CHELSA (Climatologies at High resolution for the Earth's Land Surface Areas):

```{r}
(spr_prec <- rast("data/spr_prec_us.tif"))
```

To inspect the spatial extent of the raster, we can use the `terra::ext()` function from the `terra` package.
This helps us understand the geographic coverage before cropping.

```{r}
ext(spr_prec)
```

This layer covers the entire US, so it's a pretty big raster (check with `geom_spatraster()`).

To crop a raster, we provide the bounding box of the area we want to retain.
In the example below, we keep the area bounded by longitudes -80 to -75 and latitudes 34 to 37.

```{r}
## crop to:
## longitude range: -80 to -75
## latitude range: 34 to 37
spr_prec_crop <- crop(x = spr_prec,
                      y = c(-80, -75, 34, 37))
```

The selected area partially covers North Carolina.
However, since it's a little difficult to imagine where this raster spans geographically, we load a vector dataset of North Carolina counties.
We can then overlay both the raster and vector data to get a better sense of geographic coverage.

```{r}
## load county vector 
sf_nc_county <- readRDS("data/sf_nc_county.rds")

ggplot() +
  geom_spatraster(data = spr_prec_crop) +
  geom_sf(data = sf_nc_county,
          alpha = 0.25) ## alpha = 0.25 makes the polygon layer transparent
```

The resulting plot reveals that the raster and vector extents do not perfectly align.

### Crop by a vector extent {.unnumbered}

In later analyses, it's common to work with raster and vector data together, so it's helpful to know how to crop a raster layer using the spatial extent of a vector object.

In the following example, we crop the raster using the extent of the `sf_nc_county` object, which ensures that the spatial extents of the two datasets match.

```{r}
spr_prec_nc <- crop(x = spr_prec,
                    y = sf_nc_county)

```

Let's visualize the cropped raster and vector data together again to confirm that they now align correctly.

```{r}
ggplot() +
  geom_spatraster(data = spr_prec_nc) +
  geom_sf(data = sf_nc_county,
          alpha = 0.25) ## alpha = 0.25 makes the polygon layer transparent
```

## Merge

The `merge()` function performs the opposite of `crop()`: it combines multiple raster layers into a single, unified raster.
This operation is essential when working with large geographic datasets that span multiple tiles.
For example, if you need to calculate summary statistics within a polygon boundary that crosses several raster layers, those rasters must first be merged to ensure the statistics are computed accurately across the entire area of interest.

### Merge two tiles {.unnumbered}

To try out the `merge()` function, we’ll use a set of precipitation raster tiles, each representing one quarter of North Carolina.

```{r}
spr_nw <- rast("data/spr_prec_ncnw.tif") # Northwest NC
spr_ne <- rast("data/spr_prec_ncne.tif") # Northeast NC
spr_sw <- rast("data/spr_prec_ncsw.tif") # Southwest NC
spr_se <- rast("data/spr_prec_ncse.tif") # Southeast NC
```

As before, you can use `geom_spatraster()` for visual check:

```{r}
ggplot() +
  geom_spatraster(data = spr_nw) +
  geom_sf(data = sf_nc_county,
          alpha = 0.25)
```

Check the other layers (`spr_ne`, `spr_sw`, `spr_se`) -- each one covers a different quarter of North Carolina.

While these individual tiles are useful for, e.g., county-level analysis, they fall short if you want to perform a statewide analysis.
Merging two tiles into a single raster is straightforward using the `merge()` function.

```{r}
spr_n <- merge(spr_nw, spr_ne)
```

The `spr_n` layer is a combination of the northern tiles and should now cover the northern half of the state.

```{r}
ggplot() +
  geom_spatraster(data = spr_n) +
  geom_sf(data = sf_nc_county,
          alpha = 0.25)
```

### Merge more than two tiles {.unnumbered}

If we wish to merge more than two raster tiles at once, it's often more efficient to use a SpatRaster Collection.
This allows us to organize multiple `SpatRaster` objects into a single collection that can be handled by functions like `merge()` more easily.

First, we gather the individual tiles into a list:

```{r}
list_spr <- list(spr_nw,
                 spr_ne,
                 spr_sw,
                 spr_se)
```

Then, we convert this list into a `SpatRasterCollection` using the `terra::sprc()` function:

```{r}
spr_col <- sprc(list_spr)
```

Now that we have a raster collection, we can merge all tiles into a single, unified raster layer:

```{r}
spr_merge <- merge(spr_col)
```

This final merged raster covers the entire extent of North Carolina.

```{r}
ggplot() +
  geom_spatraster(data = spr_merge) +
  geom_sf(data = sf_nc_county,
          alpha = 0.25)
```

## Stack

If we have multiple layers of the same extent and resolution, we can "stack" them to aggregate.
This stacked raster is particularly usefule when analyzing multiple environmental variables at once - see Chapter

```{r}
spr_prec_nc <- rast("data/spr_prec_nc.tif")
spr_tmp_nc <- rast("data/spr_tmp_nc.tif")
```

```{r}
print(spr_prec_nc)
```

```{r}
print(spr_tmp_nc)
```

```{r}
spr_pt_nc <- c(spr_prec_nc,
               spr_tmp_nc)
```

## Projection
